---
import Layout from "@layouts/Layout.astro";
import { Icon } from "astro-icon/components";
import { electricityConsumptionData } from "./electricity-consumption-data.ts";

// Get transformer data
const moorside = electricityConsumptionData["26730028"];
const ridgemoor = electricityConsumptionData["26730050"];
const braemoor = electricityConsumptionData["26730039"];
---

<Layout title="Electricity Consumption Report">
  <!-- Section 1: Overview -->
  <section
    class="min-h-screen w-full flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-slate-800 dark:to-slate-900"
  >
    <div class="container mx-auto px-6 py-20">
      <div class="text-center mb-16">
        <h1 class="text-5xl md:text-7xl font-bold text-gray-900 dark:text-white mb-6">
          Electricity Consumption Report
        </h1>
        <p class="text-xl md:text-2xl text-gray-600 dark:text-gray-300 max-w-3xl mx-auto">
          Comprehensive analysis of energy usage patterns and efficiency metrics for Strata NW2040
        </p>
      </div>

      <!-- Current Situation Overview -->
      <div class="max-w-6xl mx-auto">
        <div class="bg-white dark:bg-slate-800 rounded-3xl p-8 shadow-2xl mb-8">
          <h2 class="text-3xl font-bold text-center text-gray-900 dark:text-white mb-8">Current Situation</h2>
          <p class="text-lg text-center text-gray-600 dark:text-gray-300 mb-12">
            Three transformers distributed unevenly across the complex
          </p>

          <div class="grid md:grid-cols-3 gap-8">
            <!-- Transformer 26730050 - Ridgemoor -->
            <div
              class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-slate-800 dark:to-slate-700 rounded-2xl p-6 border-2 border-gray-200 dark:border-slate-600"
            >
              <div class="text-center mb-4">
                <div class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                  <Icon name="bx:bxs-bolt" class="text-2xl text-white" />
                </div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">{ridgemoor.name}</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  Moderate Usage • {ridgemoor.maxRating} • {ridgemoor.totalNumberOfServicedUnits} units
                </p>
              </div>
              <div class="space-y-3">
                <div class="bg-white dark:bg-slate-700 rounded-lg p-3">
                  <p class="text-sm text-gray-600 dark:text-gray-400">Units Connected</p>
                  <p class="text-2xl font-bold text-gray-900 dark:text-white">{ridgemoor.totalNumberOfServicedUnits}</p>
                </div>
                <div class="bg-white dark:bg-slate-700 rounded-lg p-3">
                  <p class="text-sm text-gray-600 dark:text-gray-400">Max Rated Capacity</p>
                  <p class="text-2xl font-bold text-gray-900 dark:text-white">{ridgemoor.maxRating}</p>
                </div>
                <div class="bg-white dark:bg-slate-700 rounded-lg p-3">
                  <p class="text-sm text-gray-600 dark:text-gray-400">Current Peak Usage</p>
                  <p class="text-lg font-bold text-red-600 dark:text-red-400">
                    {ridgemoor.currentUsage.max.Afternoon} kWh
                    <span class="text-sm text-gray-500"
                      >({
                        ((ridgemoor.currentUsage.max.Afternoon / parseInt(ridgemoor.maxRating)) * 100).toFixed(0)
                      }%)</span
                    >
                  </p>
                </div>
              </div>
            </div>

            <!-- Transformer 26730028 - Moorside -->
            <div
              class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-slate-800 dark:to-slate-700 rounded-2xl p-6 border-2 border-gray-200 dark:border-slate-600"
            >
              <div class="text-center mb-4">
                <div class="w-16 h-16 bg-orange-500 rounded-full flex items-center justify-center mx-auto mb-4">
                  <Icon name="bx:bxs-bolt" class="text-2xl text-white" />
                </div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">{moorside.name}</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  Highest Usage • {moorside.maxRating} • {moorside.totalNumberOfServicedUnits} units
                </p>
              </div>
              <div class="space-y-3">
                <div class="bg-white dark:bg-slate-700 rounded-lg p-3">
                  <p class="text-sm text-gray-600 dark:text-gray-400">Units Connected</p>
                  <p class="text-2xl font-bold text-gray-900 dark:text-white">{moorside.totalNumberOfServicedUnits}</p>
                </div>
                <div class="bg-white dark:bg-slate-700 rounded-lg p-3">
                  <p class="text-sm text-gray-600 dark:text-gray-400">Max Rated Capacity</p>
                  <p class="text-2xl font-bold text-gray-900 dark:text-white">{moorside.maxRating}</p>
                </div>
                <div class="bg-white dark:bg-slate-700 rounded-lg p-3">
                  <p class="text-sm text-gray-600 dark:text-gray-400">Current Peak Usage</p>
                  <p class="text-lg font-bold text-orange-600 dark:text-orange-400">
                    {moorside.currentUsage.max.Evening} kWh
                    <span class="text-sm text-gray-500"
                      >({((moorside.currentUsage.max.Evening / parseInt(moorside.maxRating)) * 100).toFixed(0)}%)</span
                    >
                  </p>
                </div>
              </div>
            </div>

            <!-- Transformer 26730039 - Braemoor -->
            <div
              class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-slate-800 dark:to-slate-700 rounded-2xl p-6 border-2 border-gray-200 dark:border-slate-600"
            >
              <div class="text-center mb-4">
                <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                  <Icon name="bx:bxs-bolt" class="text-2xl text-white" />
                </div>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">{braemoor.name}</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  Lowest Usage • {braemoor.maxRating} • {braemoor.totalNumberOfServicedUnits} units
                </p>
              </div>
              <div class="space-y-3">
                <div class="bg-white dark:bg-slate-700 rounded-lg p-3">
                  <p class="text-sm text-gray-600 dark:text-gray-400">Units Connected</p>
                  <p class="text-2xl font-bold text-gray-900 dark:text-white">{braemoor.totalNumberOfServicedUnits}</p>
                </div>
                <div class="bg-white dark:bg-slate-700 rounded-lg p-3">
                  <p class="text-sm text-gray-600 dark:text-gray-400">Max Rated Capacity</p>
                  <p class="text-2xl font-bold text-gray-900 dark:text-white">{braemoor.maxRating}</p>
                </div>
                <div class="bg-white dark:bg-slate-700 rounded-lg p-3">
                  <p class="text-sm text-gray-600 dark:text-gray-400">Current Peak Usage</p>
                  <p class="text-lg font-bold text-green-600 dark:text-green-400">
                    {braemoor.currentUsage.max.Afternoon} kWh
                    <span class="text-sm text-gray-500"
                      >({
                        ((braemoor.currentUsage.max.Afternoon / parseInt(braemoor.maxRating)) * 100).toFixed(0)
                      }%)</span
                    >
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Section 2: Analyzing Averages -->
  <section
    class="min-h-screen w-full flex items-center justify-center bg-gradient-to-br from-green-50 to-emerald-10 dark:from-slate-900 dark:to-slate-800"
  >
    <div class="container mx-auto px-6 py-20">
      <div class="text-center mb-16">
        <h2 class="text-4xl md:text-6xl font-bold text-gray-900 dark:text-white mb-6">Data Analysis Method</h2>
        <p class="text-xl text-gray-600 dark:text-gray-300 max-w-3xl mx-auto">
          Why peak analysis provides better insights than averages alone
        </p>
      </div>

      <!-- Our Analysis Method -->
      <div class="max-w-4xl mx-auto mb-16">
        <div class="bg-white dark:bg-slate-800 rounded-3xl p-8 shadow-2xl text-center">
          <p class="text-lg text-gray-700 dark:text-gray-300 max-w-4xl mx-auto mb-6">
            This report focuses on <strong>peak usage patterns</strong> and <strong>capacity utilization</strong> rather
            than just averages. Peak loads determine infrastructure requirements and reveal potential bottlenecks that averages
            can mask.
          </p>
        </div>
      </div>

      <!-- Analysis Content -->
      <div class="max-w-6xl mx-auto">
        <div class="bg-white dark:bg-slate-800 rounded-3xl p-8 shadow-2xl">
          <div class="grid lg:grid-cols-2 gap-12 items-center">
            <!-- Left Side: The Problem with Averages -->
            <div>
              <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">The Problem with Averages</h3>

              <div class="space-y-6">
                <div class="bg-red-50 dark:bg-red-900/20 rounded-xl p-6 border-l-4 border-red-500">
                  <h4 class="font-semibold text-red-800 dark:text-red-300 mb-2">Hidden Peaks</h4>
                  <p class="text-gray-700 dark:text-gray-300 text-sm">
                    Average consumption masks critical peak usage periods that can overload transformers and cause
                    outages.
                  </p>
                </div>

                <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-xl p-6 border-l-4 border-yellow-500">
                  <h4 class="font-semibold text-yellow-800 dark:text-yellow-300 mb-2">Uneven Distribution</h4>
                  <p class="text-gray-700 dark:text-gray-300 text-sm">
                    Averages don't reveal which transformers are consistently overloaded while others remain
                    underutilized.
                  </p>
                </div>

                <div class="bg-orange-50 dark:bg-orange-900/20 rounded-xl p-6 border-l-4 border-orange-500">
                  <h4 class="font-semibold text-orange-800 dark:text-orange-300 mb-2">Time-Based Patterns</h4>
                  <p class="text-gray-700 dark:text-gray-300 text-sm">
                    Daily and seasonal variations are lost when data is averaged, hiding critical usage patterns.
                  </p>
                </div>
              </div>
            </div>

            <!-- Right Side: Visual Example -->
            <div>
              <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Real Example</h3>

              <div
                class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl p-6"
              >
                <h4 class="font-semibold text-gray-900 dark:text-white mb-4">{moorside.name} (Transformer 26730028)</h4>

                <div class="space-y-4">
                  <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Daily Average:</span>
                    <span class="text-lg font-bold text-blue-600 dark:text-blue-400">
                      {
                        (
                          (moorside.currentUsage.max.Night +
                            moorside.currentUsage.max.Morning +
                            moorside.currentUsage.max.Afternoon +
                            moorside.currentUsage.max.Evening) /
                          4
                        ).toFixed(1)
                      } kWh
                    </span>
                  </div>

                  <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Peak Usage:</span>
                    <span class="text-lg font-bold text-red-600 dark:text-red-400"
                      >{moorside.currentUsage.max.Evening} kWh</span
                    >
                  </div>

                  <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
                    <div
                      class="bg-gradient-to-r from-blue-500 to-red-500 h-3 rounded-full"
                      style={`width: ${(moorside.currentUsage.max.Evening / moorside.currentUsage.max.Evening) * 100}%`}
                    >
                    </div>
                  </div>

                  <p class="text-xs text-gray-500 dark:text-gray-400 text-center">
                    Peak is {
                      (
                        (moorside.currentUsage.max.Evening /
                          ((moorside.currentUsage.max.Night +
                            moorside.currentUsage.max.Morning +
                            moorside.currentUsage.max.Afternoon +
                            moorside.currentUsage.max.Evening) /
                            4) -
                          1) *
                        100
                      ).toFixed(0)
                    }% higher than daily average
                  </p>
                </div>
              </div>

              <div
                class="mt-6 bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-xl p-6"
              >
                <h4 class="font-semibold text-gray-900 dark:text-white mb-4">The Impact</h4>
                <ul class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                  <li class="flex items-center">
                    <Icon name="bx:check" class="text-green-500 mr-2" />
                    System appears stable at average levels
                  </li>
                  <li class="flex items-center">
                    <Icon name="bx:x" class="text-red-500 mr-2" />
                    Peak loads cause transformer stress
                  </li>
                  <li class="flex items-center">
                    <Icon name="bx:x" class="text-red-500 mr-2" />
                    Risk of equipment failure during peak times
                  </li>
                  <li class="flex items-center">
                    <Icon name="bx:x" class="text-red-500 mr-2" />
                    Potential power outages for residents
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Charts: Real Usage Averages per Transformer -->
          <div class="mt-12">
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 text-center">
              Transformer Averages by Time Chunk
            </h3>
            <div class="grid md:grid-cols-3 gap-8">
              <div class="bg-white dark:bg-slate-700 rounded-xl p-4 shadow">
                <h4 class="text-center font-semibold text-gray-900 dark:text-white mb-2">Transformer 26730028</h4>
                <div class="relative h-64 md:h-80">
                  <canvas id="chart26730028"></canvas>
                </div>
              </div>
              <div class="bg-white dark:bg-slate-700 rounded-xl p-4 shadow">
                <h4 class="text-center font-semibold text-gray-900 dark:text-white mb-2">Transformer 26730039</h4>
                <div class="relative h-64 md:h-80">
                  <canvas id="chart26730039"></canvas>
                </div>
              </div>
              <div class="bg-white dark:bg-slate-700 rounded-xl p-4 shadow">
                <h4 class="text-center font-semibold text-gray-900 dark:text-white mb-2">Transformer 26730050</h4>
                <div class="relative h-64 md:h-80">
                  <canvas id="chart26730050"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <section>
    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-6 mt-6">
      <Icon name="bx:bxs-data" class="text-3xl text-blue-600 dark:text-blue-400 mx-auto mb-3" />
      <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-3">Verify Our Analysis</h4>
      <p class="text-gray-700 dark:text-gray-300 mb-4">
        Don't trust our insights? Analyze the data yourself! We believe in transparency and encourage independent
        verification.
      </p>
      <a
        href="/raw-data-download-link"
        class="inline-flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors duration-200"
        target="_blank"
        rel="noopener noreferrer"
      >
        <Icon name="bx:download" class="mr-2" />
        Download Raw Data (CSV)
      </a>
    </div>
  </section>
</Layout>

<script>
  import Chart from "chart.js/auto";

  // Aggregated averages provided by user: { [TimeChunk]: { [TransformerID]: value } }
  const aggregatedAverages = {
    "Night (12 AM - 6 AM)": { "26730028": 6.78653, "26730039": 4.10668, "26730050": 5.46378 },
    "Morning (6 AM - 12 PM)": { "26730028": 9.654, "26730039": 6.24147, "26730050": 7.38963 },
    "Afternoon (12 PM - 6 PM)": { "26730028": 11.9943, "26730039": 7.83361, "26730050": 9.6967 },
    "Evening (6 PM - 12 AM)": { "26730028": 13.0385, "26730039": 7.8205, "26730050": 9.06881 },
  } as const;

  const chunkLabels = [
    "Night (12 AM - 6 AM)",
    "Morning (6 AM - 12 PM)",
    "Afternoon (12 PM - 6 PM)",
    "Evening (6 PM - 12 AM)",
  ];

  const colorMap = {
    "26730028": { bg: "rgba(239, 68, 68, 0.8)", border: "rgb(239, 68, 68)" },
    "26730039": { bg: "rgba(245, 158, 11, 0.8)", border: "rgb(245, 158, 11)" },
    "26730050": { bg: "rgba(249, 115, 22, 0.8)", border: "rgb(249, 115, 22)" },
  } as const;

  const transformerData = {
    averages: {
      "26730028": {
        labels: chunkLabels,
        datasets: [
          {
            label: "Average Usage (kWh)",
            data: chunkLabels.map((l) => aggregatedAverages[l]["26730028"]),
            backgroundColor: colorMap["26730028"].bg,
            borderColor: colorMap["26730028"].border,
            borderWidth: 2,
          },
        ],
      },
      "26730039": {
        labels: chunkLabels,
        datasets: [
          {
            label: "Average Usage (kWh)",
            data: chunkLabels.map((l) => aggregatedAverages[l]["26730039"]),
            backgroundColor: colorMap["26730039"].bg,
            borderColor: colorMap["26730039"].border,
            borderWidth: 2,
          },
        ],
      },
      "26730050": {
        labels: chunkLabels,
        datasets: [
          {
            label: "Average Usage (kWh)",
            data: chunkLabels.map((l) => aggregatedAverages[l]["26730050"]),
            backgroundColor: colorMap["26730050"].bg,
            borderColor: colorMap["26730050"].border,
            borderWidth: 2,
          },
        ],
      },
    },
  };

  // Initialize transformer charts
  let transformerCharts = {};

  function initCharts() {
    const transformerIds = ["26730028", "26730039", "26730050"];

    transformerIds.forEach((id) => {
      const ctx = document.getElementById(`chart${id}`) as HTMLCanvasElement;
      if (ctx) {
        transformerCharts[id] = new Chart(ctx, {
          type: "bar",
          data: transformerData.averages[id],
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              x: {
                ticks: {
                  color: window.matchMedia("(prefers-color-scheme: dark)").matches ? "#e5e7eb" : "#374151",
                  maxRotation: 45,
                },
                grid: {
                  color: window.matchMedia("(prefers-color-scheme: dark)").matches ? "#374151" : "#e5e7eb",
                },
              },
              y: {
                ticks: {
                  color: window.matchMedia("(prefers-color-scheme: dark)").matches ? "#e5e7eb" : "#374151",
                },
                grid: {
                  color: window.matchMedia("(prefers-color-scheme: dark)").matches ? "#374151" : "#e5e7eb",
                },
                beginAtZero: true,
              },
            },
          },
        });
      }
    });
  }

  // Data toggle functionality
  function setupChartToggles() {
    const dataToggles = document.querySelectorAll(".data-toggle");
    dataToggles.forEach((toggle) => {
      toggle.addEventListener("click", () => {
        // Update button states
        dataToggles.forEach((t) => {
          t.classList.remove("active", "bg-green-600", "text-white");
          t.classList.add("bg-gray-200", "dark:bg-gray-600", "text-gray-700", "dark:text-gray-300");
        });

        toggle.classList.add("active", "bg-green-600", "text-white");
        toggle.classList.remove("bg-gray-200", "dark:bg-gray-600", "text-gray-700", "dark:text-gray-300");

        // Update all transformer charts
        const dataType = (toggle as HTMLElement).dataset.type;
        if (dataType && transformerData[dataType as keyof typeof transformerData]) {
          Object.keys(transformerCharts).forEach((transformerId) => {
            if (transformerCharts[transformerId]) {
              transformerCharts[transformerId].data =
                transformerData[dataType as keyof typeof transformerData][transformerId];
              transformerCharts[transformerId].update();
            }
          });
        }
      });
    });
  }

  // Initialize everything when DOM is loaded
  document.addEventListener("DOMContentLoaded", () => {
    initCharts();
    setupChartToggles();
  });
</script>

<style>
  .data-toggle.active {
    @apply bg-green-600 text-white;
  }

  /* Smooth scrolling for full-screen sections */
  html {
    scroll-behavior: smooth;
  }

  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-track {
    background: #f1f1f1;
  }

  ::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: #555;
  }

  /* Dark mode scrollbar */
  @media (prefers-color-scheme: dark) {
    ::-webkit-scrollbar-track {
      background: #374151;
    }

    ::-webkit-scrollbar-thumb {
      background: #6b7280;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }
  }
</style>
